<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nixbit Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Login Screen -->
        <div id="login-screen" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                        Nixbit Admin Access
                    </h2>
                    <p class="mt-2 text-center text-sm text-gray-600">
                        Administrator authentication required
                    </p>
                </div>
                <form id="login-form" class="mt-8 space-y-6" onsubmit="return false;">
                    <div class="rounded-md shadow-sm space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input id="email" name="email" type="email" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="admin@nixbit.dev">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input id="password" name="password" type="password" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Enter admin password">
                        </div>
                    </div>

                    <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded"></div>

                    <div>
                        <button type="button" id="login-btn"
                                class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50">
                            Sign In
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Password Change Screen -->
        <div id="password-change-screen" class="hidden min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                        Change Default Password
                    </h2>
                    <p class="mt-2 text-center text-sm text-gray-600">
                        You must change your default password before accessing the dashboard
                    </p>
                </div>
                <form id="password-change-form" class="mt-8 space-y-6" onsubmit="return false;">
                    <div class="rounded-md shadow-sm space-y-4">
                        <div>
                            <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                            <input id="current-password" name="current-password" type="password" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Enter current password">
                        </div>
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                            <input id="new-password" name="new-password" type="password" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Enter new password (min 8 characters)">
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                            <input id="confirm-password" name="confirm-password" type="password" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Confirm new password">
                        </div>
                    </div>

                    <div id="password-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded"></div>
                    <div id="password-success" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded"></div>

                    <div>
                        <button type="button" id="password-change-btn"
                                class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50">
                            Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main Dashboard (hidden initially) -->
        <div id="dashboard" class="hidden">
            <!-- Header -->
            <header class="bg-white shadow">
                <div class="mx-auto max-w-7xl px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <h1 class="text-2xl font-bold text-gray-900">Nixbit Admin Dashboard</h1>
                            <span class="ml-4 text-sm text-green-600 bg-green-50 px-3 py-1 rounded-full">Authenticated</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-500">System Health</span>
                            <div id="health-indicator" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                            <button onclick="logout()" class="text-sm text-gray-600 hover:text-gray-900">Logout</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="mx-auto max-w-7xl px-6 py-8">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Total Users</h3>
                        <p id="total-users" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Active Projects</h3>
                        <p id="active-projects" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Emails Sent</h3>
                        <p id="emails-sent" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Function Calls</h3>
                        <p id="function-calls" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">System Status</h3>
                        <p id="system-status" class="text-2xl font-bold text-green-600">Healthy</p>
                    </div>
                </div>

                <!-- Netlify Usage Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Netlify Function Usage -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Netlify Function Usage</h3>
                        <div class="mb-6">
                            <canvas id="functionUsageChart" width="400" height="200"></canvas>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Function Invocations (24h)</span>
                                <span id="function-invocations" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Runtime (total seconds)</span>
                                <span id="function-runtime" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Most Called Function</span>
                                <span id="top-function" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Error Rate</span>
                                <span id="function-errors" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Netlify Bandwidth & Storage -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Netlify Resources</h3>
                        <div class="mb-6">
                            <canvas id="resourceUsageChart" width="400" height="200"></canvas>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Bandwidth Used (24h)</span>
                                <span id="bandwidth-used" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Build Minutes (month)</span>
                                <span id="build-minutes" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Site Deploys (24h)</span>
                                <span id="site-deploys" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Form Submissions</span>
                                <span id="form-submissions" class="text-sm font-medium text-gray-900">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div class="bg-white rounded-lg shadow mb-8">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">User Management</h3>
                                <p class="text-sm text-gray-600">View and manage application users</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-500">Active Users:</span>
                                    <span id="active-users-count" class="text-sm font-medium text-green-600">-</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-500">New This Week:</span>
                                    <span id="new-users-week" class="text-sm font-medium text-blue-600">-</span>
                                </div>
                                <button onclick="refreshUsers()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                    🔄 Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Bar -->
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <input
                                    type="text"
                                    id="user-search"
                                    placeholder="Search users by email, name, or ID..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 text-sm"
                                    onkeyup="handleUserSearch(event)"
                                >
                            </div>
                            <select id="user-sort" onchange="sortUsers()" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 text-sm">
                                <option value="createdAt-desc">Newest First</option>
                                <option value="createdAt-asc">Oldest First</option>
                                <option value="email-asc">Email A-Z</option>
                                <option value="email-desc">Email Z-A</option>
                                <option value="lastLogin-desc">Last Login</option>
                            </select>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Users Table Footer -->
                    <div class="px-6 py-3 border-t border-gray-200 bg-gray-50">
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <span id="users-count-display">Showing 0 users</span>
                            <span id="users-last-updated">Last updated: -</span>
                        </div>
                    </div>
                </div>

                <!-- Marketing Analytics Section -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">📈 Marketing Analytics</h2>
                    
                    <!-- Marketing Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Total Signups</h3>
                                    <p id="marketing-total" class="text-2xl font-bold text-gray-900">-</p>
                                </div>
                                <div class="text-blue-500">
                                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">This Week</h3>
                                    <p id="marketing-week" class="text-2xl font-bold text-green-600">-</p>
                                    <p id="marketing-week-growth" class="text-xs text-gray-500">-</p>
                                </div>
                                <div class="text-green-500">
                                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">This Month</h3>
                                    <p id="marketing-month" class="text-2xl font-bold text-blue-600">-</p>
                                    <p id="marketing-month-growth" class="text-xs text-gray-500">-</p>
                                </div>
                                <div class="text-blue-500">
                                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">This Year</h3>
                                    <p id="marketing-year" class="text-2xl font-bold text-purple-600">-</p>
                                </div>
                                <div class="text-purple-500">
                                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Marketing Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Signup Trends (30 Days)</h3>
                            <canvas id="marketingTrendsChart" width="400" height="200"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Signup Sources</h3>
                            <canvas id="marketingSourcesChart" width="400" height="200"></canvas>
                            <div id="marketing-sources-legend" class="mt-4 space-y-2">
                                <!-- Sources will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Recent Signups -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Recent Marketing Signups</h3>
                            <button onclick="refreshMarketingData()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                🔄 Refresh
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Signed Up</th>
                                    </tr>
                                </thead>
                                <tbody id="marketing-signups-table" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">
                                            Loading marketing signups...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Data -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Email System Status -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Email System</h3>
                        <div class="mb-6">
                            <canvas id="emailSystemChart" width="400" height="200"></canvas>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">SendGrid Status</span>
                                <span id="sendgrid-status" class="text-sm font-medium text-green-600">Operational</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Welcome Emails</span>
                                <span id="welcome-emails" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Delivery Rate</span>
                                <span id="delivery-rate" class="text-sm font-medium text-gray-900">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Activity</h3>
                        <div id="recent-activity" class="space-y-3">
                            <div class="text-sm text-gray-500">Loading activity...</div>
                        </div>
                    </div>

                    <!-- System Health -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">System Health</h3>
                        <div id="health-checks" class="space-y-3">
                            <div class="text-sm text-gray-500">Loading health checks...</div>
                        </div>
                    </div>

                    <!-- Monitoring Logs -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Logs</h3>
                        <div id="monitoring-logs" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-sm text-gray-500">Loading logs...</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Admin Dashboard with Authentication
        class SecureAdminDashboard {
            constructor() {
                this.baseUrl = window.location.origin;
                this.authToken = localStorage.getItem('nixbit_admin_token');
                this.adminPassword = localStorage.getItem('nixbit_admin_password') || 'nixbit2025'; // Default password
                this.charts = {};
                this.marketingLoading = false; // Prevent multiple simultaneous marketing analytics calls
                this.init();
            }

            async init() {
                console.log('🔐 Secure Admin Dashboard Initialized');
                
                // Check existing authentication
                if (this.authToken && await this.validateToken()) {
                    this.showDashboard();
                } else {
                    this.showLogin();
                }
            }

            showLogin() {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('password-change-screen').classList.add('hidden');
                
                // Setup login button click handler
                const loginBtn = document.getElementById('login-btn');
                loginBtn.onclick = () => {
                    this.handleLogin();
                };
                
                // Also handle form submission (double safety)
                const loginForm = document.getElementById('login-form');
                loginForm.onsubmit = (e) => {
                    e.preventDefault();
                    this.handleLogin();
                    return false;
                };
            }

            showPasswordChange() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('password-change-screen').classList.remove('hidden');
                
                // Setup password change button click handler
                const passwordBtn = document.getElementById('password-change-btn');
                passwordBtn.onclick = () => {
                    this.handlePasswordChange();
                };
                
                // Also handle form submission (double safety)
                const passwordForm = document.getElementById('password-change-form');
                passwordForm.onsubmit = (e) => {
                    e.preventDefault();
                    this.handlePasswordChange();
                    return false;
                };
            }

            showDashboard() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Start dashboard functionality
                this.loadDashboardData();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    this.loadSystemHealth();
                    this.loadRecentActivity();
                    this.loadNetlifyMetrics();
                    // Don't auto-refresh marketing analytics to avoid chart conflicts
                    // Users can manually refresh marketing data with the refresh button
                }, 30000);
            }

            async handleLogin() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('login-btn');
                const errorDiv = document.getElementById('login-error');

                loginBtn.disabled = true;
                loginBtn.textContent = 'Signing In...';
                errorDiv.classList.add('hidden');

                try {
                    // Admin-only credentials check
                    if (email === 'admin@nixbit.dev' && password === this.adminPassword) {
                        // Check if using default password
                        if (password === 'nixbit2025') {
                            console.log('🔐 First login detected - password change required');
                            this.showPasswordChange();
                            return;
                        }
                        
                        // Create admin token
                        const token = btoa(JSON.stringify({
                            email: email,
                            role: 'admin',
                            exp: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                        }));
                        
                        localStorage.setItem('nixbit_admin_token', token);
                        this.authToken = token;
                        
                        console.log('✅ Admin authentication successful');
                        this.showDashboard();
                    } else {
                        throw new Error('Invalid admin credentials');
                    }
                } catch (error) {
                    console.error('❌ Login failed:', error);
                    errorDiv.textContent = 'Invalid credentials. Use admin@nixbit.dev with the correct password.';
                    errorDiv.classList.remove('hidden');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            }

            async handlePasswordChange() {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const changeBtn = document.getElementById('password-change-btn');
                const errorDiv = document.getElementById('password-error');
                const successDiv = document.getElementById('password-success');

                changeBtn.disabled = true;
                changeBtn.textContent = 'Changing Password...';
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');

                try {
                    // Validate current password
                    if (currentPassword !== this.adminPassword) {
                        throw new Error('Current password is incorrect');
                    }

                    // Validate new password
                    if (newPassword.length < 8) {
                        throw new Error('New password must be at least 8 characters long');
                    }

                    if (newPassword !== confirmPassword) {
                        throw new Error('New passwords do not match');
                    }

                    if (newPassword === 'nixbit2025') {
                        throw new Error('Cannot use the default password');
                    }

                    // Update password
                    this.adminPassword = newPassword;
                    localStorage.setItem('nixbit_admin_password', newPassword);

                    // Create admin token
                    const token = btoa(JSON.stringify({
                        email: 'admin@nixbit.dev',
                        role: 'admin',
                        exp: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                    }));
                    
                    localStorage.setItem('nixbit_admin_token', token);
                    this.authToken = token;

                    console.log('✅ Password changed successfully');
                    successDiv.textContent = 'Password changed successfully! Redirecting to dashboard...';
                    successDiv.classList.remove('hidden');

                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        this.showDashboard();
                    }, 2000);

                } catch (error) {
                    console.error('❌ Password change failed:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                } finally {
                    changeBtn.disabled = false;
                    changeBtn.textContent = 'Change Password';
                }
            }

            async validateToken() {
                if (!this.authToken) return false;
                
                try {
                    const payload = JSON.parse(atob(this.authToken));
                    return payload.exp > Date.now() && payload.email === 'admin@nixbit.dev';
                } catch {
                    return false;
                }
            }

            logout() {
                localStorage.removeItem('nixbit_admin_token');
                this.authToken = null;
                this.showLogin();
            }

            async loadDashboardData() {
                // Initialize charts first
                this.initializeCharts();
                
                await Promise.all([
                    this.loadSystemHealth(),
                    this.loadRecentActivity(),
                    this.loadMonitoringData(),
                    this.loadNetlifyMetrics(),
                    this.loadUsers(),
                    this.loadMarketingAnalytics()
                ]);
            }

            initializeCharts() {
                // Function Usage Chart (Doughnut)
                const functionCtx = document.getElementById('functionUsageChart');
                if (functionCtx) {
                    this.charts.functionUsage = new Chart(functionCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Auth', 'Email', 'Monitor', 'Webhooks'],
                            datasets: [{
                                data: [45, 25, 15, 15],
                                backgroundColor: [
                                    '#3b82f6', // Blue
                                    '#10b981', // Green
                                    '#f59e0b', // Yellow
                                    '#8b5cf6'  // Purple
                                ],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { fontSize: 12 }
                                }
                            }
                        }
                    });
                }

                // Resource Usage Chart (Bar)
                const resourceCtx = document.getElementById('resourceUsageChart');
                if (resourceCtx) {
                    this.charts.resourceUsage = new Chart(resourceCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Bandwidth', 'Build Min', 'Storage', 'Functions'],
                            datasets: [{
                                label: 'Usage %',
                                data: [35, 15, 8, 42],
                                backgroundColor: [
                                    '#3b82f6',
                                    '#10b981',
                                    '#f59e0b',
                                    '#ef4444'
                                ],
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { callback: function(value) { return value + '%'; } }
                                }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }

                // Email System Chart (Line)
                const emailCtx = document.getElementById('emailSystemChart');
                if (emailCtx) {
                    this.charts.emailSystem = new Chart(emailCtx, {
                        type: 'line',
                        data: {
                            labels: ['6h ago', '5h ago', '4h ago', '3h ago', '2h ago', '1h ago', 'Now'],
                            datasets: [{
                                label: 'Emails Sent',
                                data: [0, 1, 0, 2, 1, 0, 1],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            }, {
                                label: 'Delivery Rate %',
                                data: [100, 100, 100, 100, 100, 100, 100],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: false,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    position: 'left'
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    min: 95,
                                    max: 100,
                                    grid: { drawOnChartArea: false }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { fontSize: 12 }
                                }
                            }
                        }
                    });
                }

                // Marketing Trends Chart (Line) - only create if not already exists
                const marketingTrendsCtx = document.getElementById('marketingTrendsChart');
                if (marketingTrendsCtx && !this.charts.marketingTrends) {
                    this.charts.marketingTrends = new Chart(marketingTrendsCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Daily Signups',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { fontSize: 12 }
                                }
                            }
                        }
                    });
                }

                // Marketing Sources Chart (Doughnut) - only create if not already exists
                const marketingSourcesCtx = document.getElementById('marketingSourcesChart');
                if (marketingSourcesCtx && !this.charts.marketingSources) {
                    this.charts.marketingSources = new Chart(marketingSourcesCtx, {
                        type: 'doughnut',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: [
                                    '#3b82f6', // Blue
                                    '#10b981', // Green
                                    '#f59e0b', // Yellow
                                    '#8b5cf6', // Purple
                                    '#ef4444', // Red
                                    '#06b6d4', // Cyan
                                    '#84cc16'  // Lime
                                ],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false // We'll use custom legend
                                }
                            }
                        }
                    });
                }
            }

            async loadSystemHealth() {
                try {
                    console.log('📊 Loading system health...');
                    
                    const response = await fetch(`${this.baseUrl}/.netlify/functions/monitor-health`);
                    
                    if (response.ok) {
                        const health = await response.json();
                        this.updateHealthStatus(health);
                        document.getElementById('health-indicator').className = 'w-3 h-3 bg-green-400 rounded-full';
                    } else {
                        throw new Error('Health check failed');
                    }
                } catch (error) {
                    console.error('❌ Health check error:', error);
                    document.getElementById('health-indicator').className = 'w-3 h-3 bg-red-400 rounded-full';
                    document.getElementById('system-status').textContent = 'Degraded';
                    document.getElementById('system-status').className = 'text-2xl font-bold text-yellow-600';
                }
            }

            updateHealthStatus(health) {
                const statusEl = document.getElementById('system-status');
                statusEl.textContent = health.status === 'healthy' ? 'Healthy' : 
                                     health.status === 'degraded' ? 'Degraded' : 'Down';
                
                // Update status color
                statusEl.className = health.status === 'healthy' ? 'text-2xl font-bold text-green-600' :
                                    health.status === 'degraded' ? 'text-2xl font-bold text-yellow-600' :
                                    'text-2xl font-bold text-red-600';
                
                const healthChecks = document.getElementById('health-checks');
                if (health.services) {
                    const servicesHtml = Object.entries(health.services).map(([service, data]) => `
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600 capitalize">${service}</span>
                                <span class="text-xs text-gray-400">${data.responseTime}ms</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 rounded-full ${
                                    data.status === 'healthy' ? 'bg-green-400' : 
                                    data.status === 'degraded' ? 'bg-yellow-400' : 'bg-red-400'
                                }"></div>
                                <span class="text-sm font-medium ${
                                    data.status === 'healthy' ? 'text-green-600' : 
                                    data.status === 'degraded' ? 'text-yellow-600' : 'text-red-600'
                                } capitalize">
                                    ${data.status}
                                </span>
                            </div>
                        </div>
                    `).join('');
                    healthChecks.innerHTML = servicesHtml;
                    
                    // Add uptime info
                    if (health.uptime) {
                        healthChecks.innerHTML += `
                            <div class="mt-4 pt-3 border-t border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">System Uptime</span>
                                    <span class="text-sm font-medium text-gray-900">${health.uptime}</span>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            async loadRecentActivity() {
                try {
                    console.log('📝 Loading recent activity...');
                    
                    const activities = [
                        { time: new Date().toLocaleTimeString(), action: 'Admin Dashboard Access', details: 'Secure login successful' },
                        { time: new Date(Date.now() - 5 * 60000).toLocaleTimeString(), action: 'User registration', details: 'New user signed up' },
                        { time: new Date(Date.now() - 10 * 60000).toLocaleTimeString(), action: 'Welcome email', details: 'Sent via SendGrid' },
                        { time: new Date(Date.now() - 15 * 60000).toLocaleTimeString(), action: 'Health check', details: 'All systems operational' },
                    ];

                    const activityHtml = activities.map(activity => `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${activity.action}</div>
                                <div class="text-xs text-gray-500">${activity.details}</div>
                            </div>
                            <div class="text-xs text-gray-400">${activity.time}</div>
                        </div>
                    `).join('');

                    document.getElementById('recent-activity').innerHTML = activityHtml;
                } catch (error) {
                    console.error('❌ Activity loading error:', error);
                }
            }

            async loadNetlifyMetrics() {
                try {
                    console.log('📈 Loading Netlify usage metrics...');
                    
                    // Note: In production, you'd integrate with Netlify Analytics API
                    // For now, we'll simulate metrics based on actual usage patterns
                    
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const timeSinceStart = now - todayStart;
                    const hoursToday = timeSinceStart / (1000 * 60 * 60);
                    
                    // Estimate function calls based on user activity
                    const estimatedCalls = Math.floor(hoursToday * 12); // ~12 calls per hour
                    const estimatedRuntime = Math.floor(estimatedCalls * 0.3); // ~300ms average
                    const estimatedBandwidth = Math.floor(estimatedCalls * 2.5); // ~2.5KB per call
                    
                    document.getElementById('function-calls').textContent = estimatedCalls + '+';
                    document.getElementById('function-invocations').textContent = estimatedCalls + ' calls';
                    document.getElementById('function-runtime').textContent = estimatedRuntime + 's';
                    document.getElementById('bandwidth-used').textContent = (estimatedBandwidth / 1000).toFixed(1) + ' MB';
                    document.getElementById('top-function').textContent = 'auth';
                    document.getElementById('function-errors').textContent = '< 0.1%';
                    document.getElementById('build-minutes').textContent = '< 1 min';
                    document.getElementById('site-deploys').textContent = '3-5';
                    
                } catch (error) {
                    console.error('❌ Netlify metrics error:', error);
                }
            }

            async loadMonitoringData() {
                try {
                    console.log('📈 Loading monitoring data...');
                    
                    // Update email metrics
                    document.getElementById('welcome-emails').textContent = '2+';
                    document.getElementById('delivery-rate').textContent = '100%';
                    document.getElementById('emails-sent').textContent = '2+';
                    
                    // Mock other data
                    document.getElementById('total-users').textContent = '3';
                    document.getElementById('active-projects').textContent = '1';

                    // Load recent logs
                    this.loadRecentLogs();
                } catch (error) {
                    console.error('❌ Monitoring data error:', error);
                }
            }

            loadRecentLogs() {
                const logs = [
                    { time: new Date().toLocaleTimeString(), level: 'SUCCESS', message: 'Admin authentication successful' },
                    { time: new Date(Date.now() - 2 * 60000).toLocaleTimeString(), level: 'INFO', message: 'System health check completed' },
                    { time: new Date(Date.now() - 5 * 60000).toLocaleTimeString(), level: 'SUCCESS', message: 'Welcome email sent successfully' },
                    { time: new Date(Date.now() - 8 * 60000).toLocaleTimeString(), level: 'INFO', message: 'User registration completed' },
                    { time: new Date(Date.now() - 12 * 60000).toLocaleTimeString(), level: 'INFO', message: 'Authentication function called' },
                ];

                const logsHtml = logs.map(log => `
                    <div class="flex justify-between items-center text-xs">
                        <div class="flex items-center space-x-2">
                            <span class="font-mono px-2 py-1 rounded ${
                                log.level === 'SUCCESS' ? 'bg-green-100 text-green-800' :
                                log.level === 'ERROR' ? 'bg-red-100 text-red-800' :
                                'bg-blue-100 text-blue-800'
                            }">${log.level}</span>
                            <span class="text-gray-900">${log.message}</span>
                        </div>
                        <span class="text-gray-400">${log.time}</span>
                    </div>
                `).join('');

                document.getElementById('monitoring-logs').innerHTML = logsHtml;
            }

            // User Management Methods
            async loadUsers(searchQuery = '', sortBy = 'createdAt', sortOrder = 'desc') {
                try {
                    console.log('📥 Loading users data...');
                    
                    const params = new URLSearchParams({
                        search: searchQuery,
                        sortBy: sortBy,
                        sortOrder: sortOrder
                    });
                    
                    const response = await fetch(`${this.baseUrl}/.netlify/functions/admin-users?${params}`, {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.displayUsers(data);
                        this.updateUserStats(data.summary);
                    } else {
                        throw new Error('Failed to load users');
                    }
                } catch (error) {
                    console.error('❌ Users loading error:', error);
                    this.displayUsersError('Failed to load users. Please check your connection and try again.');
                }
            }

            displayUsers(data) {
                const tbody = document.getElementById('users-table-body');
                const { users, summary, query } = data;
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                ${query.search ? 'No users found matching your search.' : 'No users found.'}
                            </td>
                        </tr>
                    `;
                    return;
                }

                const usersHtml = users.map(user => {
                    const createdDate = new Date(user.createdAt).toLocaleDateString();
                    const lastLoginDate = new Date(user.lastLogin).toLocaleDateString();
                    const daysSinceLogin = Math.floor((Date.now() - new Date(user.lastLogin).getTime()) / (1000 * 60 * 60 * 24));
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-${user.role === 'admin' ? 'purple' : 'blue'}-100 flex items-center justify-center">
                                        <span class="text-${user.role === 'admin' ? 'purple' : 'blue'}-600 font-medium text-sm">
                                            ${user.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                        </span>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">${user.name}</div>
                                        <div class="text-sm text-gray-500">${user.email}</div>
                                        <div class="text-xs text-gray-400 font-mono">${user.id}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                    user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'
                                }">
                                    ${user.role === 'admin' ? '👑 Admin' : '👤 User'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div>${createdDate}</div>
                                <div class="text-xs text-gray-500">${this.getTimeAgo(user.createdAt)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div>${lastLoginDate}</div>
                                <div class="text-xs ${daysSinceLogin <= 1 ? 'text-green-600' : daysSinceLogin <= 7 ? 'text-yellow-600' : 'text-red-500'}">
                                    ${daysSinceLogin === 0 ? 'Today' : daysSinceLogin === 1 ? 'Yesterday' : `${daysSinceLogin} days ago`}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div class="space-y-1">
                                    <div>📂 ${user.projectsCreated} projects</div>
                                    <div>📊 ${user.testResultsSubmitted} results</div>
                                    <div>🔄 ${user.totalSessions} sessions</div>
                                    <div class="text-xs text-gray-500">~${user.avgSessionDuration}min avg</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                    user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                }">
                                    ${user.status === 'active' ? '✅ Active' : '⏸️ Inactive'}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = usersHtml;
                
                // Update footer
                document.getElementById('users-count-display').textContent = 
                    `Showing ${users.length} of ${summary.totalUsers} users${query.search ? ` (filtered)` : ''}`;
                document.getElementById('users-last-updated').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
            }

            displayUsersError(message) {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center">
                            <div class="text-red-600 mb-2">❌ ${message}</div>
                            <button onclick="window.dashboard.loadUsers()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                Try Again
                            </button>
                        </td>
                    </tr>
                `;
            }

            updateUserStats(summary) {
                // Update the main stats
                document.getElementById('total-users').textContent = summary.totalUsers.toString();
                document.getElementById('active-users-count').textContent = summary.activeUsers.toString();
                document.getElementById('new-users-week').textContent = summary.newUsersThisWeek.toString();
            }

            getTimeAgo(dateString) {
                const now = new Date();
                const date = new Date(dateString);
                const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));
                
                if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
                if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
                const days = Math.floor(diffInMinutes / 1440);
                if (days < 30) return `${days}d ago`;
                const months = Math.floor(days / 30);
                if (months < 12) return `${months}mo ago`;
                return `${Math.floor(months / 12)}y ago`;
            }

            // Marketing Analytics Methods
            async loadMarketingAnalytics() {
                // Prevent multiple simultaneous calls
                if (this.marketingLoading) {
                    console.log('📈 Marketing analytics already loading, skipping...');
                    return;
                }
                
                this.marketingLoading = true;
                
                try {
                    console.log('📈 Loading marketing analytics...');
                    
                    const response = await fetch(`${this.baseUrl}/.netlify/functions/marketing-analytics`, {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data) {
                            // Add safety checks for data structure
                            if (data.data.summary) {
                                this.updateMarketingMetrics(data.data.summary);
                            }
                            if (data.data.trends || data.data.sources) {
                                this.updateMarketingCharts(data.data.trends, data.data.sources);
                            }
                            if (data.data.recentSignups) {
                                this.updateRecentSignups(data.data.recentSignups);
                            }
                        } else {
                            throw new Error(data.message || 'Invalid response data structure');
                        }
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('❌ Marketing analytics loading error:', error);
                    this.showMarketingError(error.message);
                } finally {
                    this.marketingLoading = false;
                }
            }

            updateMarketingMetrics(summary) {
                document.getElementById('marketing-total').textContent = summary.total.toString();
                document.getElementById('marketing-week').textContent = summary.thisWeek.toString();
                document.getElementById('marketing-month').textContent = summary.thisMonth.toString();
                document.getElementById('marketing-year').textContent = summary.thisYear.toString();

                // Update growth indicators
                const weekGrowth = summary.weeklyGrowthRate;
                const monthGrowth = summary.monthlyGrowthRate;
                
                const weekGrowthEl = document.getElementById('marketing-week-growth');
                const monthGrowthEl = document.getElementById('marketing-month-growth');
                
                if (weekGrowthEl) {
                    const weekText = weekGrowth > 0 ? `+${weekGrowth.toFixed(1)}%` : `${weekGrowth.toFixed(1)}%`;
                    weekGrowthEl.textContent = weekText;
                    weekGrowthEl.className = `text-xs ${weekGrowth >= 0 ? 'text-green-600' : 'text-red-600'}`;
                }
                
                if (monthGrowthEl) {
                    const monthText = monthGrowth > 0 ? `+${monthGrowth.toFixed(1)}%` : `${monthGrowth.toFixed(1)}%`;
                    monthGrowthEl.textContent = monthText;
                    monthGrowthEl.className = `text-xs ${monthGrowth >= 0 ? 'text-green-600' : 'text-red-600'}`;
                }
            }

            updateMarketingCharts(trends, sources) {
                try {
                    // Update trends chart with safety checks
                    if (this.charts.marketingTrends && trends && trends.daily && Array.isArray(trends.daily)) {
                        const chart = this.charts.marketingTrends;
                        
                        // Clear existing data first
                        chart.data.labels = [];
                        chart.data.datasets[0].data = [];
                        
                        // Add new data
                        chart.data.labels = trends.daily.map(d => 
                            new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                        );
                        chart.data.datasets[0].data = trends.daily.map(d => d.count || 0);
                        
                        // Update with animation disabled to prevent conflicts
                        chart.update('none');
                    }

                    // Update sources chart with safety checks
                    if (this.charts.marketingSources && sources && typeof sources === 'object') {
                        const sourceEntries = Object.entries(sources);
                        const chart = this.charts.marketingSources;
                        
                        if (sourceEntries.length > 0) {
                            // Clear existing data first
                            chart.data.labels = [];
                            chart.data.datasets[0].data = [];
                            
                            // Add new data
                            chart.data.labels = sourceEntries.map(([source, _]) => 
                                source === 'unknown' ? 'Direct' : source.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                            );
                            chart.data.datasets[0].data = sourceEntries.map(([_, count]) => count || 0);
                            
                            // Update with animation disabled to prevent conflicts
                            chart.update('none');

                            // Update custom legend
                            this.updateSourcesLegend(sourceEntries);
                        }
                    }
                } catch (error) {
                    console.error('❌ Chart update error:', error);
                    // Don't let chart errors break the entire dashboard
                }
            }

            updateSourcesLegend(sourceEntries) {
                const legendEl = document.getElementById('marketing-sources-legend');
                if (!legendEl || !Array.isArray(sourceEntries)) return;

                try {
                    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#84cc16'];
                    const totalCount = sourceEntries.reduce((sum, [_, c]) => sum + (c || 0), 0);
                    
                    const legendHtml = sourceEntries.map(([source, count], index) => {
                        const displayName = source === 'unknown' ? 'Direct' : source.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const color = colors[index % colors.length];
                        const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) : 0;
                        
                        return `
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></div>
                                    <span class="text-gray-600">${displayName}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-gray-900 font-medium">${count || 0}</span>
                                    <span class="text-gray-500">(${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Use requestAnimationFrame to prevent layout thrashing
                    requestAnimationFrame(() => {
                        legendEl.innerHTML = legendHtml;
                    });
                } catch (error) {
                    console.error('❌ Legend update error:', error);
                    // Fallback to empty legend on error
                    legendEl.innerHTML = '<div class="text-sm text-gray-500">Unable to load sources</div>';
                }
            }

            updateRecentSignups(recentSignups) {
                const tableBody = document.getElementById('marketing-signups-table');
                if (!tableBody) return;

                if (recentSignups.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">
                                No marketing signups found
                            </td>
                        </tr>
                    `;
                    return;
                }

                const signupsHtml = recentSignups.map(signup => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${signup.email}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getSourceBadgeClass(signup.source)}">
                                ${signup.source || 'direct'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${signup.company || '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${this.getTimeAgo(signup.createdAt)}
                        </td>
                    </tr>
                `).join('');

                tableBody.innerHTML = signupsHtml;
            }

            getSourceBadgeClass(source) {
                const sourceMap = {
                    'footer-newsletter': 'bg-blue-100 text-blue-800',
                    'homepage': 'bg-green-100 text-green-800',
                    'social': 'bg-purple-100 text-purple-800',
                    'referral': 'bg-yellow-100 text-yellow-800',
                    'direct': 'bg-gray-100 text-gray-800'
                };
                return sourceMap[source] || 'bg-gray-100 text-gray-800';
            }

            showMarketingError(message) {
                // Update metrics with error state
                document.getElementById('marketing-total').textContent = 'Error';
                document.getElementById('marketing-week').textContent = 'Error';
                document.getElementById('marketing-month').textContent = 'Error';
                document.getElementById('marketing-year').textContent = 'Error';

                // Update table with error message
                const tableBody = document.getElementById('marketing-signups-table');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-sm text-red-600">
                                Failed to load marketing analytics: ${message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Global functions for user management
        function refreshUsers() {
            if (window.dashboard) {
                const searchQuery = document.getElementById('user-search').value;
                const sortSelect = document.getElementById('user-sort');
                const [sortBy, sortOrder] = sortSelect.value.split('-');
                window.dashboard.loadUsers(searchQuery, sortBy, sortOrder);
            }
        }

        function handleUserSearch(event) {
            if (event.key === 'Enter' || event.type === 'search') {
                refreshUsers();
            }
            // Also trigger search after user stops typing (debounced)
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(refreshUsers, 500);
        }

        function sortUsers() {
            refreshUsers();
        }

        // Global functions for marketing analytics
        function refreshMarketingData() {
            if (window.dashboard) {
                window.dashboard.loadMarketingAnalytics();
            }
        }

        // Global logout function
        function logout() {
            if (window.dashboard) {
                window.dashboard.logout();
            }
        }

        // Initialize secure dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM Content Loaded - Initializing Dashboard');
            window.dashboard = new SecureAdminDashboard();
        });

        // Fallback initialization in case DOMContentLoaded has already fired
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                if (!window.dashboard) {
                    console.log('🔄 Fallback initialization');
                    window.dashboard = new SecureAdminDashboard();
                }
            });
        } else {
            console.log('🔄 Direct initialization');
            window.dashboard = new SecureAdminDashboard();
        }
    </script>
</body>
</html>